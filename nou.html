<!DOCTYPE html>
<html>

<head>
    <title>Prova</title>
    <style>
        body {
            margin: 0px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            /*background-image: url("./diagrama.png");
            background-repeat: no-repeat;*/
            background-size: 560px;
        }
        
        .sino {
            position: absolute;
            font-weight: bolder;
        }
        
        .br {
            text-shadow: 0 1px white;
            font-weight: bolder;
            color: #b8bec5;
        }
        
        .etiqueta {
            position: absolute;
            font-weight: bolder;
            text-align: center;
            z-index: 1;
        }
        
        .quadrat {
            position: absolute;
            border: 1px solid black;
            background-color: gray;
            opacity: 1;
            z-index: 0;
        }
        
        .rombo {
            position: absolute;
            border: 1px solid black;
            background-color: gray;
            transform: rotate(45deg);
            opacity: 1;
            z-index: 0;
        }
        
        #nht {
            /*position: absolute;*/
            left: 73px;
            top: 141px;
            width: 108px;
            height: 50px;
        }
        
        @keyframes example {
            from {
                background-color: red;
            }
            to {
                background-color: yellow;
            }
        }
        
        #funciona {
            left: 248px;
            top: 39px;
            width: 82px;
            height: 82px;
            animation-name: example;
            animation-duration: 2s;
            animation-iteration-count: infinite;
        }
        
        #hht {
            left: 442px;
            top: 124px;
            width: 75px;
            height: 75px;
        }
        
        #burro {
            left: 237px;
            top: 195px;
            width: 105px;
            height: 47px;
        }
        
        #hsa {
            left: 88px;
            top: 242px;
            width: 75px;
            height: 75px;
        }
        
        #lhc {
            left: 237px;
            top: 326px;
            width: 105px;
            height: 47px;
        }
        
        #ah {
            left: 64px;
            top: 392px;
            width: 117px;
            height: 47px;
        }
        
        #pcaa {
            left: 247px;
            top: 430px;
            width: 85px;
            height: 85px;
        }
        
        #edp {
            left: 426px;
            top: 262px;
            width: 106px;
            height: 106px;
        }
        
        #lh {
            left: 426px;
            top: 477px;
            width: 107px;
            height: 47px;
        }
        
        #np {
            left: 214px;
            top: 589px;
            width: 152px;
            height: 47px;
        }
    </style>
</head>

<body>
    <div id="diagrama-flux" style="position: absolute; top: 0px; left: 0px">
        <svg height="800" width="600">
        <polyline
          points="126,141 126,81 232,81"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="348,81 480,81 480,110"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="290,196 290,162 427,162"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="480,212 480,242"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="126,191 126,228"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="290,242 290,326"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="170,281 280,281 280,326"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="126,331 126,392"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="300,326 300,315 427,315"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="481,389 481,477"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="290,373 290,414"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="290,531 290,589"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="260,350 200,350 200,474 231,474"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="126,439 126,614 214,614"
          style="fill: none; stroke: black; stroke-width: 3"
        />
        <polyline
          points="324,614 479,614 479,524"
          style="fill: none; stroke: black; stroke-width: 3"
        />
      </svg>
        <div stlye="z-index: 1;">
            <div class="sino" style="left: 188px; top: 57px">SI</div>
            <div class="sino" style="left: 377px; top: 57px">NO</div>
            <div class="br etiqueta" style="position: absolute; left: 244px; top: 71px">
                FUNCIONA?
            </div>
            <div id="funciona" class="rombo"></div>
        </div>
        <div stlye="z-index: 1;">
            <div id="nhtt" class="etiqueta" style="position: absolute; left: 95px; top: 148px">
                NO HO
                <br /> TOQUIS!
            </div>
            <div id="nht" class="quadrat"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="sino" style="left: 374px; top: 137px">SI</div>
            <div class="sino" style="left: 487px; top: 217px">NO</div>
            <div class="etiqueta" style="left: 448px; top: 142px">
                HO HAS
                <br /> TOCAT?
            </div>
            <div id="hht" class="rombo"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="etiqueta" style="left: 260px; top: 210px">BURRO!</div>
            <div id="burro" class="quadrat"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="etiqueta" style="left: 262px; top: 331px">
                L'HAS
                <br /> CAGAT!
            </div>
            <div id="lhc" class="quadrat"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="sino" style="left: 187px; top: 254px">SI</div>
            <div class="sino" style="left: 95px; top: 348px">NO</div>
            <div class="etiqueta" style="left: 94px; top: 262px">
                HO SAP
                <br /> ALG&Uacute;?
            </div>
            <div id="hsa" class="rombo"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="etiqueta" style="left: 75px; top: 407px">AMAGA-HO!</div>
            <div id="ah" class="quadrat"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="sino" style="left: 374px; top: 292px">SI</div>
            <div class="sino" style="left: 487px; top: 411px">NO</div>
            <div class="etiqueta" style="left: 427px; top: 296px">
                ET DONAR&Agrave;
                <br /> PROBLEMES?
            </div>
            <div id="edp" class="rombo"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="sino" style="left: 269px; top: 546px">SI</div>
            <div class="sino" style="left: 205px; top: 478px">NO</div>
            <div class="etiqueta" style="left: 257px; top: 432px">
                POTS
                <br /> CULPAR <br /> ALG&Uacute; <br /> ALTRE?
            </div>
            <div id="pcaa" class="rombo"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="etiqueta" style="left: 431px; top: 492px">LLENÃ‡A-HO!</div>
            <div id="lh" class="quadrat"></div>
        </div>
        <div stlye="z-index: 1;">
            <div class="etiqueta" style="left: 226px; top: 604px">
                CAP PROBLEMA!
            </div>
            <div id="np" class="quadrat"></div>
        </div>
    </div>
    <p>HOLA</p>
    <div id="output"></div>
    <script>
        function automat(ajustos) {
            this._actual = ajustos.estatInicial;
            this.accions = ajustos.accions;
            this.estats = ajustos.estats;
        }

        let resposta = "KeyX";

        window.addEventListener(
            "keydown",
            function(event) {
                resposta = event.code;
                if (resposta === "KeyS" || resposta === "KeyN") {
                    const p = document.createElement("p");
                    p.textContent = `KeyboardEvent: key='${event.key}' | code='${event.code}'`;
                    document.getElementById("output").appendChild(p);
                    if (resposta === "KeyS") estatAutomat.emit("si");
                    else estatAutomat.emit("no");
                }
            },
            true
        );

        let prototip = automat.prototype;

        prototip.emit = function(esdeveniment) {
            let estat = this.estats[this._actual];
            let transicio = estat[esdeveniment];
            if (!transicio) {
                throw new Error(
                    `Esdeveniment(${esdeveniment}) de l'actual` +
                    ` estat(${this._actual}) no existeix.`
                );
            }
            let vellEstat = this._actual;
            let nouEstat = transicio.a;
            this._actual = nouEstat;
            transicio.accions.forEach((fnName) => {
                this.accions[fnName].call(this, vellEstat, nouEstat);
            });
        };

        prototip.getState = function() {
            return this._actual;
        };

        let estatAutomat = new automat({
            estatInicial: "inicial", // Estat Inicial
            estatFinal: "final", // Estat Final

            // Tots els estats possibles. Descriu els esdeveniments per passar de l'estat actual al segÃ¼ent
            // i les accions que s'han de fer a partir d'aquest punt.

            estats: {
                inicial: {
                    // des de l'estat
                    engega: {
                        // esdeveniment
                        a: "funciona", // passa a l'estat
                        si: "funcionaSI",
                        no: "funcionaNO",
                        accions: ["funciona"], // accions a fer
                    },
                    si: {
                        a: "resposta", // passa a l'estat
                        accions: [""], // accions a fer
                    },
                    no: {
                        a: "resposta", // passa a l'estat
                        accions: [""], // accions a fer
                    },
                },
                resposta: {
                    si: {
                        a: "funciona",
                        accions: ["fesSI"],
                    },
                    no: {
                        a: "funciona",
                        accions: ["fesNO"],
                    },
                },
                funciona: {
                    si: {
                        a: "nht",
                        accions: ["nht"],
                    },
                    no: {
                        a: "hht",
                        accions: ["hht"],
                    },
                },
                nht: {
                    si: {
                        a: "hsa",
                        accions: ["hsa"],
                    },
                    no: {
                        a: "ah",
                        accions: ["ah"],
                    },
                },
                hht: {
                    si: {
                        a: "nht",
                        accions: ["nht"],
                    },
                    no: {
                        a: "hht",
                        accions: ["hht"],
                    },
                },
                b: {
                    si: {
                        a: "lhc",
                        accions: ["b"],
                    },
                    no: {
                        a: "lhc",
                        accions: ["b"],
                    },
                },
                lhc: {
                    si: {
                        a: "pcaa",
                        accions: ["lhc"],
                    },
                    no: {
                        a: "lhc",
                        accions: ["lhc"],
                    },
                },
                hsa: {
                    si: {
                        a: "lhc",
                        accions: ["lhc"],
                    },
                    no: {
                        a: "ah",
                        accions: ["ah"],
                    },
                },
                pcaa: {
                    si: {
                        a: "cp",
                        accions: ["cp"],
                    },
                    no: {
                        a: "lhc",
                        accions: ["lhc"],
                    },
                },
                ah: {
                    si: {
                        a: "cp",
                        accions: ["ah"],
                    },
                    no: {
                        a: "cp",
                        accions: ["ah"],
                    },
                },
                cp: {
                    si: {
                        a: "cp",
                        accions: ["cp"],
                    },
                    no: {
                        a: "cp",
                        accions: ["cp"],
                    },
                },
                final: {
                    si: {
                        a: "final",
                        accions: ["timeout"],
                    },
                    no: {
                        a: "final",
                        accions: ["timeout"],
                    },
                },
            },
            accions: {
                funciona: function() {
                    setTimeout(() => {
                        this.emit("si");
                    }, 2000);
                    alert("Funciona?");
                },
                nht: function() {
                    let tmp = document.getElementById("funciona").style;
                    tmp.removeProperty("animationName");
                    tmp.removeProperty("animationDuration");
                    tmp.removeProperty("animationIterationCount");
                    tmp.backgroundColor = "red";
                    document.getElementById("nhtt").className += " br";
                    tmp = document.getElementById("nht");
                    tmp.style.animationName = "example";
                    tmp.style.animationDuration = "2s";
                    tmp.style.animationIterationCount = "infinite";
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                hht: function() {
                    alert("Ho has tocat?");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                hsa: function() {
                    alert("Ho sap algÃº?");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                lhc: function() {
                    alert("L'has cagat!");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                edp: function() {
                    alert("Et donarÃ  problemes?");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                ah: function() {
                    alert("Amaga-ho!");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                lh: function() {
                    alert("LlenÃ§a-ho!");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                },
                cp: function() {
                    alert("Cap problema!");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                    throw new Error(0);
                },
                timeout: function() {
                    alert("FINAL");
                    setTimeout(() => {
                        this.emit("si");
                    }, 500);
                    throw new Error(0);
                },
            },
        });
        estatAutomat.emit("engega");
    </script>
</body>

</html>